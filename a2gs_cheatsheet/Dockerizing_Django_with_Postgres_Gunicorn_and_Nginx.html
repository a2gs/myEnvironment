





<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" type="image/png" href="/static/images/favicon.5ce1f18967ae.png">
    
  <!-- blog meta -->
  <meta property="og:title" content="Dockerizing Django with Postgres, Gunicorn, and Nginx" />
  <meta property="og:image" content="https://testdriven.io/static/images/blog/django-docker/dockerizing_django.png" />
  <meta name="description" property="og:description" content="This tutorial details how to configure Django to run on Docker along with Postgres, Nginx, and Gunicorn.">
  <meta name="keywords" content="django, python, docker, django and docker">

    
    <title>Dockerizing Django with Postgres, Gunicorn, and Nginx | TestDriven.io</title>

    
       

    <!-- CSS Styles -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css"
      integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B"
      crossorigin="anonymous"
    >
    <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
    
  
  <link rel="stylesheet" href="/static/css/blog.0c51ff810a97.css">

    <link rel="stylesheet" href="/static/css/base.1eb80d93402e.css">
    <link rel="stylesheet" href="/static/css/pygments.7262fcc7e9ed.css">
    
      <link rel="stylesheet" href="/static/css/pygments_error.bbadc7ab2566.css">
    
  </head>
  <body>

    
      <!-- Google Tag Manager (noscript) -->
      <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-57PX49D"
      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
      <!-- End Google Tag Manager (noscript) -->
    

    <!-- Nav -->
    
      
    
    

    <!-- Main content -->
    

  <div class="container">
    <div class="row">
      <div class="col-lg-9">
        

  <main>
    

    <div class="text-center" style="padding-bottom:20px;">
      <img src="/static/images/blog/django-docker/dockerizing_django.png" style="max-width:100%" alt="django and docker">
    </div>
    <h1 class="d-none d-md-block">Dockerizing Django with Postgres, Gunicorn, and Nginx</h1>
    <h2 class="d-md-none blog-mobile-title">Dockerizing Django with Postgres, Gunicorn, and Nginx</h2>
    <hr><br>
    <div class="d-none d-sm-block post-info-large">
      <!-- hidden on screens smaller than sm -->
      <p>
        <span>Posted by <a href="/authors/herman/">Michael Herman</a></span>
        <span>&vert;</span>
        <span>Last updated on </Span>
        <span class="badge badge-secondary">August 13th, 2019</span>
      </p>
    </div>
    <div class="d-sm-none post-info-small">
      <!-- hidden on screens wider than sm -->
      <p>
        <span>Posted by <a href="/authors/herman/">Michael Herman</a></span>
        <br>
        <span>Last updated on </Span>
        <span class="badge badge-secondary">August 13th, 2019</span>
      </p>
    </div>
    <br>
    <p><p>This is a step-by-step tutorial that details how to configure Django to run on Docker with Postgres. For production environments, we'll add on Nginx and Gunicorn. We'll also take a look at how to serve Django static and media files via Nginx.</p>
<p><em>Dependencies</em>:</p>
<ol>
<li>Django v2.2.4</li>
<li>Docker v19.03.1</li>
<li>Python v3.7.4</li>
</ol>
<h2 class="toc-header">Contents</h2>

<div class="toc">
<ul>
<li><a href="#project-setup">Project Setup</a></li>
<li><a href="#docker">Docker</a></li>
<li><a href="#postgres">Postgres</a></li>
<li><a href="#gunicorn">Gunicorn</a></li>
<li><a href="#production-dockerfile">Production Dockerfile</a></li>
<li><a href="#nginx">Nginx</a></li>
<li><a href="#static-files">Static Files</a></li>
<li><a href="#media-files">Media Files</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
<h2 id="project-setup">Project Setup</h2>
<p>Assuming you have <a href="https://pipenv.readthedocs.io/">Pipenv</a> installed, start by creating a new Django project:</p>
<div class="codehilite"><pre><span></span>$ mkdir django-on-docker <span class="o">&amp;&amp;</span> <span class="nb">cd</span> django-on-docker
$ mkdir app <span class="o">&amp;&amp;</span> <span class="nb">cd</span> app
$ pipenv install <span class="nv">django</span><span class="o">==</span><span class="m">2</span>.2.4
$ pipenv shell
<span class="o">(</span>app-I8NuipNz<span class="o">)</span>$ django-admin.py startproject hello_django .
<span class="o">(</span>app-I8NuipNz<span class="o">)</span>$ python manage.py migrate
<span class="o">(</span>app-I8NuipNz<span class="o">)</span>$ python manage.py runserver
</pre></div>


<p>Navigate to <a href="http://localhost:8000/">http://localhost:8000/</a> to view the Django welcome screen. Kill the server and exit from the Pipenv shell once done.</p>
<p>Your project directory should look like:</p>
<div class="codehilite"><pre><span></span>└── app
    ├── Pipfile
    ├── Pipfile.lock
    ├── hello_django
    │   ├── __init__.py
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py
    └── manage.py
</pre></div>


<h2 id="docker">Docker</h2>
<p>Install <a href="https://docs.docker.com/install/">Docker</a>, if you don't already have it, then add a <em>Dockerfile</em> to the "app" directory:</p>
<div class="codehilite"><pre><span></span><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="s"> python:3.7.4-alpine</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="s"> /usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span> PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span> PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install dependencies</span>
<span class="k">RUN</span> pip install --upgrade pip
<span class="k">RUN</span> pip install pipenv
<span class="k">COPY</span> ./Pipfile /usr/src/app/Pipfile
<span class="k">RUN</span> pipenv install --skip-lock --system --dev

<span class="c"># copy project</span>
<span class="k">COPY</span> . /usr/src/app/
</pre></div>


<p>So, we started with an <a href="https://github.com/gliderlabs/docker-alpine">Alpine</a>-based <a href="https://hub.docker.com/_/python/">Docker image</a> for Python 3.7.4. We then set a <a href="https://docs.docker.com/engine/reference/builder/#workdir">working directory</a> along with two environment variables:</p>
<ol>
<li><code>PYTHONDONTWRITEBYTECODE</code>: Prevents Python from writing pyc files to disc (equivalent to <code>python -B</code> <a href="https://docs.python.org/3/using/cmdline.html#id1">option</a>)</li>
<li><code>PYTHONUNBUFFERED</code>: Prevents Python from buffering stdout and stderr (equivalent to <code>python -u</code> <a href="https://docs.python.org/3/using/cmdline.html#cmdoption-u">option</a>)</li>
</ol>
<p>Finally, we installed Pipenv, copied over the local Pipfile, installed the dependencies, and copied over the Django project itself.</p>
<blockquote>
<p>Review <a href="https://mherman.org/presentations/dockercon-2018">Docker for Python Developers</a> for more on structuring Dockerfiles as well as some best practices for configuring Docker for Python-based development.</p>
</blockquote>
<p>Next, add a <em>docker-compose.yml</em> to the project root:</p>
<div class="codehilite"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.7&#39;</span>

<span class="nt">services</span><span class="p">:</span>
  <span class="nt">web</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./app</span>
    <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python manage.py runserver 0.0.0.0:8000</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./app/:/usr/src/app/</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8000:8000</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DEBUG=1</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=foo</span>
</pre></div>


<blockquote>
<p>Review the <a href="https://docs.docker.com/compose/compose-file/">Compose file reference</a> for info on how this file works.</p>
</blockquote>
<p>Update the <code>SECRET_KEY</code>, <code>DEBUG</code>, and <code>ALLOWED_HOSTS</code> variables in <em>settings.py</em>:</p>
<div class="codehilite"><pre><span></span><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">)</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">]</span>
</pre></div>


<p>Build the image:</p>
<div class="codehilite"><pre><span></span>$ docker-compose build
</pre></div>


<p>Once the image is built, run the container:</p>
<div class="codehilite"><pre><span></span>$ docker-compose up -d
</pre></div>


<p>Navigate to <a href="http://localhost:8000/">http://localhost:8000/</a> to again view the welcome screen.</p>
<h2 id="postgres">Postgres</h2>
<p>To configure Postgres, we'll need to add a new service to the <em>docker-compose.yml</em> file, update the Django settings, and install <a href="http://initd.org/psycopg/">Psycopg2</a>.</p>
<p>First, add a new service called <code>db</code> to <em>docker-compose.yml</em>:</p>
<div class="codehilite"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.7&#39;</span>

<span class="nt">services</span><span class="p">:</span>
  <span class="nt">web</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./app</span>
    <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python manage.py runserver 0.0.0.0:8000</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./app/:/usr/src/app/</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8000:8000</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DEBUG=1</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=foo</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SQL_ENGINE=django.db.backends.postgresql</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SQL_DATABASE=hello_django_dev</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SQL_USER=hello_django</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SQL_PASSWORD=hello_django</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SQL_HOST=db</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SQL_PORT=5432</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">db</span>
  <span class="nt">db</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres:11.5-alpine</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=hello_django</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=hello_django</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=hello_django_dev</span>

<span class="nt">volumes</span><span class="p">:</span>
  <span class="nt">postgres_data</span><span class="p">:</span>
</pre></div>


<p>To persist the data beyond the life of the container we configured a volume. This config will bind <code>postgres_data</code> to the "/var/lib/postgresql/data/" directory in the container.</p>
<p>We also added an environment section to define a name for the default database and set a username and password. Review the "Environment Variables" section of the <a href="https://hub.docker.com/_/postgres">Postgres Docker Hub page</a> for more info. Take note of the new environment variables in the <code>web</code> service.</p>
<p>Update the <code>DATABASES</code> dict in <em>settings.py</em>:</p>
<div class="codehilite"><pre><span></span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SQL_ENGINE&#39;</span><span class="p">,</span> <span class="s1">&#39;django.db.backends.sqlite3&#39;</span><span class="p">),</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SQL_DATABASE&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;db.sqlite3&#39;</span><span class="p">)),</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SQL_USER&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">),</span>
        <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SQL_PASSWORD&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">),</span>
        <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SQL_HOST&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">),</span>
        <span class="s1">&#39;PORT&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SQL_PORT&#39;</span><span class="p">,</span> <span class="s1">&#39;5432&#39;</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Update the Dockerfile to install the appropriate packages along with Psycopg2:</p>
<div class="codehilite"><pre><span></span><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="s"> python:3.7.4-alpine</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="s"> /usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span> PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span> PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install psycopg2</span>
<span class="k">RUN</span> apk update <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add --virtual build-deps gcc python3-dev musl-dev <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add postgresql-dev <span class="se">\</span>
    <span class="o">&amp;&amp;</span> pip install psycopg2 <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk del build-deps

<span class="c"># install dependencies</span>
<span class="k">RUN</span> pip install --upgrade pip
<span class="k">RUN</span> pip install pipenv
<span class="k">COPY</span> ./Pipfile /usr/src/app/Pipfile
<span class="k">RUN</span> pipenv install --skip-lock --system --dev

<span class="c"># copy project</span>
<span class="k">COPY</span> . /usr/src/app/
</pre></div>


<blockquote>
<p>Review <a href="https://github.com/psycopg/psycopg2/issues/684">this GitHub Issue</a> for more info on installing Psycopg2 in an Alpine-based Docker Image.</p>
</blockquote>
<p>Build the new image and spin up the two containers:</p>
<div class="codehilite"><pre><span></span>$ docker-compose up -d --build
</pre></div>


<p>Run the migrations:</p>
<div class="codehilite"><pre><span></span>$ docker-compose <span class="nb">exec</span> web python manage.py migrate --noinput
</pre></div>


<blockquote>
<p>Get the following error?</p>
<div class="codehilite"><pre><span></span>django.db.utils.OperationalError: FATAL:  database <span class="s2">"hello_django_dev"</span> does not exist
</pre></div><p>Run <code>docker-compose down -v</code> to remove the volumes along with the containers. Then, re-build the images, run the containers, and apply the migrations.</p></blockquote>

<p>Ensure the default Django tables were created:</p>
<div class="codehilite"><pre><span></span>$ docker-compose <span class="nb">exec</span> db psql --username<span class="o">=</span>hello_django --dbname<span class="o">=</span>hello_django_dev

psql <span class="o">(</span><span class="m">11</span>.5<span class="o">)</span>
Type <span class="s2">&quot;help&quot;</span> <span class="k">for</span> help.

<span class="nv">hello_django_dev</span><span class="o">=</span><span class="c1"># \l</span>
                                          List of databases
       Name       <span class="p">|</span>    Owner     <span class="p">|</span> Encoding <span class="p">|</span>  Collate   <span class="p">|</span>   Ctype    <span class="p">|</span>       Access privileges
------------------+--------------+----------+------------+------------+-------------------------------
 hello_django_dev <span class="p">|</span> hello_django <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 postgres         <span class="p">|</span> hello_django <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span>
 template0        <span class="p">|</span> hello_django <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/hello_django              +
                  <span class="p">|</span>              <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">hello_django</span><span class="o">=</span>CTc/hello_django
 template1        <span class="p">|</span> hello_django <span class="p">|</span> UTF8     <span class="p">|</span> en_US.utf8 <span class="p">|</span> en_US.utf8 <span class="p">|</span> <span class="o">=</span>c/hello_django              +
                  <span class="p">|</span>              <span class="p">|</span>          <span class="p">|</span>            <span class="p">|</span>            <span class="p">|</span> <span class="nv">hello_django</span><span class="o">=</span>CTc/hello_django
<span class="o">(</span><span class="m">4</span> rows<span class="o">)</span>

<span class="nv">hello_django_dev</span><span class="o">=</span><span class="c1"># \c hello_django_dev</span>
You are now connected to database <span class="s2">&quot;hello_django_dev&quot;</span> as user <span class="s2">&quot;hello_django&quot;</span>.

<span class="nv">hello_django_dev</span><span class="o">=</span><span class="c1"># \dt</span>
                     List of relations
 Schema <span class="p">|</span>            Name            <span class="p">|</span> Type  <span class="p">|</span>    Owner
--------+----------------------------+-------+--------------
 public <span class="p">|</span> auth_group                 <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> auth_group_permissions     <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> auth_permission            <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> auth_user                  <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> auth_user_groups           <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> auth_user_user_permissions <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> django_admin_log           <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> django_content_type        <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> django_migrations          <span class="p">|</span> table <span class="p">|</span> hello_django
 public <span class="p">|</span> django_session             <span class="p">|</span> table <span class="p">|</span> hello_django
<span class="o">(</span><span class="m">10</span> rows<span class="o">)</span>

<span class="nv">hello_django_dev</span><span class="o">=</span><span class="c1"># \q</span>
</pre></div>


<p>You can check that the volume was created as well by running:</p>
<div class="codehilite"><pre><span></span>$ docker volume inspect django-on-docker_postgres_data
</pre></div>


<p>You should see something similar to:</p>
<div class="codehilite"><pre><span></span><span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">&quot;CreatedAt&quot;</span>: <span class="s2">&quot;2019-08-12T18:35:01Z&quot;</span>,
        <span class="s2">&quot;Driver&quot;</span>: <span class="s2">&quot;local&quot;</span>,
        <span class="s2">&quot;Labels&quot;</span>: <span class="o">{</span>
            <span class="s2">&quot;com.docker.compose.project&quot;</span>: <span class="s2">&quot;django-on-docker&quot;</span>,
            <span class="s2">&quot;com.docker.compose.version&quot;</span>: <span class="s2">&quot;1.24.1&quot;</span>,
            <span class="s2">&quot;com.docker.compose.volume&quot;</span>: <span class="s2">&quot;postgres_data&quot;</span>
        <span class="o">}</span>,
        <span class="s2">&quot;Mountpoint&quot;</span>: <span class="s2">&quot;/var/lib/docker/volumes/django-on-docker_postgres_data/_data&quot;</span>,
        <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;django-on-docker_postgres_data&quot;</span>,
        <span class="s2">&quot;Options&quot;</span>: null,
        <span class="s2">&quot;Scope&quot;</span>: <span class="s2">&quot;local&quot;</span>
    <span class="o">}</span>
<span class="o">]</span>
</pre></div>


<p>Next, add an <em>entrypoint.sh</em> file to the "app" directory to verify that Postgres is healthy <em>before</em> applying the migrations and running the Django development server:</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$DATABASE</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;postgres&quot;</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for postgres...&quot;</span>

    <span class="k">while</span> ! nc -z <span class="nv">$SQL_HOST</span> <span class="nv">$SQL_PORT</span><span class="p">;</span> <span class="k">do</span>
      sleep <span class="m">0</span>.1
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">&quot;PostgreSQL started&quot;</span>
<span class="k">fi</span>

python manage.py flush --no-input
python manage.py migrate

<span class="nb">exec</span> <span class="s2">&quot;</span><span class="nv"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0a2e4a">[email&#160;protected]</a></span><span class="s2">&quot;</span>
</pre></div>


<p>Update the file permissions locally:</p>
<div class="codehilite"><pre><span></span>$ chmod +x app/entrypoint.sh
</pre></div>


<p>Then, update the Dockerfile to copy over the <em>entrypoint.sh</em> file and run it as the Docker <a href="https://docs.docker.com/engine/reference/builder/#entrypoint">entrypoint</a> command:</p>
<div class="codehilite"><pre><span></span><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="s"> python:3.7.4-alpine</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="s"> /usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span> PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span> PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install psycopg2</span>
<span class="k">RUN</span> apk update <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add --virtual build-deps gcc python3-dev musl-dev <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add postgresql-dev <span class="se">\</span>
    <span class="o">&amp;&amp;</span> pip install psycopg2 <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk del build-deps

<span class="c"># install dependencies</span>
<span class="k">RUN</span> pip install --upgrade pip
<span class="k">RUN</span> pip install pipenv
<span class="k">COPY</span> ./Pipfile /usr/src/app/Pipfile
<span class="k">RUN</span> pipenv install --skip-lock --system --dev

<span class="c"># copy entrypoint.sh</span>
<span class="k">COPY</span> ./entrypoint.sh /usr/src/app/entrypoint.sh

<span class="c"># copy project</span>
<span class="k">COPY</span> . /usr/src/app/

<span class="c"># run entrypoint.sh</span>
<span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;/usr/src/app/entrypoint.sh&quot;</span><span class="p">]</span>
</pre></div>


<p>Add the <code>DATABASE</code> environment variable to <em>docker-compose.yml</em>:</p>
<div class="codehilite"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.7&#39;</span>

<span class="nt">services</span><span class="p">:</span>
  <span class="nt">web</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./app</span>
    <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python manage.py runserver 0.0.0.0:8000</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./app/:/usr/src/app/</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8000:8000</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DEBUG=1</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=foo</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SQL_ENGINE=django.db.backends.postgresql</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SQL_DATABASE=hello_django_dev</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SQL_USER=hello_django</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SQL_PASSWORD=hello_django</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SQL_HOST=db</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SQL_PORT=5432</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DATABASE=postgres</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">db</span>
  <span class="nt">db</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres:11.5-alpine</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=hello_django</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=hello_django</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=hello_django_dev</span>

<span class="nt">volumes</span><span class="p">:</span>
  <span class="nt">postgres_data</span><span class="p">:</span>
</pre></div>


<p>Test it out again:</p>
<ol>
<li>Re-build the images</li>
<li>Run the containers</li>
<li>Try <a href="http://localhost:8000/">http://localhost:8000/</a></li>
</ol>
<blockquote>
<p>Despite adding Postgres, we can still create an independent Docker image for Django as long as the <code>DATABASE</code> environment variable is not set to <code>postgres</code>. To test, build a new image and then run a new container:
</p>
<div class="codehilite"><pre><span></span>$ docker build -f ./app/Dockerfile -t hello_django:latest ./app
$ docker run -p <span class="m">8001</span>:8000 -e <span class="s2">"SECRET_KEY=please_change_me"</span> -e <span class="s2">"DEBUG=1"</span> <span class="se">\</span>
    hello_django python /usr/src/app/manage.py runserver <span class="m">0</span>.0.0.0:8000
</pre></div><p>You should be able to view the welcome page at <a href="http://localhost:8001">http://localhost:8001</a>.</p></blockquote>

<h2 id="gunicorn">Gunicorn</h2>
<p>Moving along, for production environments, let's add <a href="https://gunicorn.org/">Gunicorn</a>, a production-grade WSGI server, to the Pipfile:</p>
<div class="codehilite"><pre><span></span><span class="k">[[source]]</span>

<span class="na">url</span> <span class="o">=</span> <span class="s">&quot;https://pypi.python.org/simple&quot;</span>
<span class="na">verify_ssl</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">name</span> <span class="o">=</span> <span class="s">&quot;pypi&quot;</span>


<span class="k">[packages]</span>

<span class="na">django</span> <span class="o">=</span> <span class="s">&quot;==2.2.4&quot;</span>
<span class="na">gunicorn</span><span class="o">=</span> <span class="s">&quot;==19.9.0&quot;</span>


<span class="k">[dev-packages]</span>



<span class="k">[requires]</span>

<span class="na">python_version</span> <span class="o">=</span> <span class="s">&quot;3.7.4&quot;</span>
</pre></div>


<p>Since we still want to use Django's built-in server in development, create a new compose file called <em>docker-compose.prod.yml</em> for production:</p>
<div class="codehilite"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.7&#39;</span>

<span class="nt">services</span><span class="p">:</span>
  <span class="nt">web</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./app</span>
    <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8000:8000</span>
    <span class="nt">env_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.env</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">db</span>
  <span class="nt">db</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres:11.5-alpine</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span>
    <span class="nt">env_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.env.db</span>

<span class="nt">volumes</span><span class="p">:</span>
  <span class="nt">postgres_data</span><span class="p">:</span>
</pre></div>


<blockquote>
<p>If you have multiple environments, you may want to look at using a <a href="https://docs.docker.com/compose/extends/">docker-compose.override.yml</a> configuration file. With this approach, you'd add your base config to a <em>docker-compose.yml</em> file and then use a <em>docker-compose.override.yml</em> file to override those config settings based on the environment.</p>
</blockquote>
<p>Take note of the default <code>command</code>. We're running Gunicorn rather than the Django development server. We also removed the volume from the <code>web</code> service since we don't need it in production. Finally, we're now using <a href="https://docs.docker.com/compose/env-file/">separate environment variable files</a> to define environment variables that will be passed to the container.</p>
<p><em>.env</em>:</p>
<div class="codehilite"><pre><span></span>DEBUG=0
SECRET_KEY=change_me
SQL_ENGINE=django.db.backends.postgresql
SQL_DATABASE=hello_django_prod
SQL_USER=hello_django
SQL_PASSWORD=hello_django
SQL_HOST=db
SQL_PORT=5432
DATABASE=postgres
</pre></div>


<p><em>.env.db</em>:</p>
<div class="codehilite"><pre><span></span>POSTGRES_USER=hello_django
POSTGRES_PASSWORD=hello_django
POSTGRES_DB=hello_django_prod
</pre></div>


<p>Add the two files to the project root. You'll probably want to keep them out of version control, so add them to a <em>.gitignore</em> file.</p>
<p>Bring down the development containers (and the associated volumes):</p>
<div class="codehilite"><pre><span></span>$ docker-compose down -v
</pre></div>


<p>Then, build the production images and spin up the containers:</p>
<div class="codehilite"><pre><span></span>$ docker-compose -f docker-compose.prod.yml up -d --build
</pre></div>


<p>Verify that the <code>hello_django_prod</code> database was created along with the default Django tables. Test out the admin page at <a href="http://localhost:8000/admin">http://localhost:8000/admin</a>. The static files are not being loaded anymore. This is expected since Debug mode is off. We'll fix this shortly.</p>
<h2 id="production-dockerfile">Production Dockerfile</h2>
<p>Did you notice that we're still running the database <a href="https://docs.djangoproject.com/en/2.2/ref/django-admin/#flush">flush</a> (which clears out the database) and migrate commands every time the container is run? This is fine in development, but let's create a new entrypoint file for production.</p>
<p><em>entrypoint.prod.sh</em>:</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$DATABASE</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;postgres&quot;</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for postgres...&quot;</span>

    <span class="k">while</span> ! nc -z <span class="nv">$SQL_HOST</span> <span class="nv">$SQL_PORT</span><span class="p">;</span> <span class="k">do</span>
      sleep <span class="m">0</span>.1
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">&quot;PostgreSQL started&quot;</span>
<span class="k">fi</span>

<span class="nb">exec</span> <span class="s2">&quot;</span><span class="nv"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ae8aee">[email&#160;protected]</a></span><span class="s2">&quot;</span>
</pre></div>


<p>Update the file permissions locally:</p>
<div class="codehilite"><pre><span></span>$ chmod +x app/entrypoint.prod.sh
</pre></div>


<p>To use this file, create a new Dockerfile called <em>Dockerfile.prod</em> for use with production builds:</p>
<div class="codehilite"><pre><span></span><span class="c"># pull official base image</span>
<span class="k">FROM</span><span class="s"> python:3.7.4-alpine</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="s"> /usr/src/app</span>

<span class="c"># set environment variables</span>
<span class="k">ENV</span> PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span> PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># install psycopg2</span>
<span class="k">RUN</span> apk update <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add --virtual build-deps gcc python3-dev musl-dev <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk add postgresql-dev <span class="se">\</span>
    <span class="o">&amp;&amp;</span> pip install psycopg2 <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apk del build-deps

<span class="c"># install dependencies</span>
<span class="k">RUN</span> pip install --upgrade pip
<span class="k">RUN</span> pip install pipenv
<span class="k">COPY</span> ./Pipfile /usr/src/app/Pipfile
<span class="k">RUN</span> pipenv install --skip-lock --system

<span class="c"># copy entrypoint-prod.sh</span>
<span class="k">COPY</span> ./entrypoint.prod.sh /usr/src/app/entrypoint.prod.sh

<span class="c"># copy project</span>
<span class="k">COPY</span> . /usr/src/app/

<span class="c"># run entrypoint.prod.sh</span>
<span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;/usr/src/app/entrypoint.prod.sh&quot;</span><span class="p">]</span>
</pre></div>


<blockquote>
<p>You could take a <a href="https://stackoverflow.com/a/53101932/1799408">multi-stage build approach</a> with a single <em>Dockerfile</em> instead of creating two Dockerfiles. Think of the pros and cons of using this approach over two different files.</p>
</blockquote>
<p>Update the <code>web</code> service within the <em>docker-compose.prod.yml</em> file to build with <em>Dockerfile.prod</em>:</p>
<div class="codehilite"><pre><span></span><span class="nt">web</span><span class="p">:</span>
  <span class="nt">build</span><span class="p">:</span>
    <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./app</span>
    <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span>
  <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000</span>
  <span class="nt">ports</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8000:8000</span>
  <span class="nt">env_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.env</span>
  <span class="nt">depends_on</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">db</span>
</pre></div>


<p>Try it out:</p>
<div class="codehilite"><pre><span></span>$ docker-compose -f docker-compose.prod.yml down -v
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py migrate --noinput
</pre></div>


<h2 id="nginx">Nginx</h2>
<p>Next, let's let's add Nginx into the mix to act as a <a href="https://www.nginx.com/resources/glossary/reverse-proxy-server/">reverse proxy</a> for Gunicorn to handle client requests as well as serve up static files.</p>
<p>Add the service to <em>docker-compose.prod.yml</em>:</p>
<div class="codehilite"><pre><span></span><span class="nt">nginx</span><span class="p">:</span>
  <span class="nt">build</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./nginx</span>
  <span class="nt">ports</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1337:80</span>
  <span class="nt">depends_on</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
</pre></div>


<p>Then, in the local project root, create the following files and folders:</p>
<div class="codehilite"><pre><span></span>└── nginx
    ├── Dockerfile
    └── nginx.conf
</pre></div>


<p><em>Dockerfile</em>:</p>
<div class="codehilite"><pre><span></span><span class="k">FROM</span><span class="s"> nginx:1.17.2-alpine</span>

<span class="k">RUN</span> rm /etc/nginx/conf.d/default.conf
<span class="k">COPY</span> nginx.conf /etc/nginx/conf.d
</pre></div>


<p><em>nginx.conf</em>:</p>
<div class="codehilite"><pre><span></span>upstream hello_django <span class="o">{</span>
    server web:8000<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>

    listen <span class="m">80</span><span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://hello_django<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<blockquote>
<p>Review <a href="https://docs.nginx.com/nginx/admin-guide/web-server/app-gateway-uwsgi-django/">Using NGINX and NGINX Plus as an Application Gateway with uWSGI and Django</a> for more info on configuring Nginx to work with Django.</p>
</blockquote>
<p>Then, update the <code>web</code> service, in <em>docker-compose.prod.yml</em>, like so:</p>
<div class="codehilite"><pre><span></span><span class="nt">web</span><span class="p">:</span>
  <span class="nt">build</span><span class="p">:</span>
    <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./app</span>
    <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span>
  <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000</span>
  <span class="nt">expose</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8000</span>
  <span class="nt">env_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.env</span>
  <span class="nt">depends_on</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">db</span>
</pre></div>


<p>Now, port 8000 is only exposed internally, to other Docker services.</p>
<p>Test it out again.</p>
<div class="codehilite"><pre><span></span>$ docker-compose -f docker-compose.prod.yml down -v
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py migrate --noinput
</pre></div>


<p>Ensure the app is up and running at <a href="http://localhost:1337">http://localhost:1337</a>.</p>
<p>Your project structure should now look like:</p>
<div class="codehilite"><pre><span></span>├── .env
├── .env.db
├── app
│   ├── Dockerfile
│   ├── Dockerfile.prod
│   ├── Pipfile
│   ├── Pipfile.lock
│   ├── entrypoint.prod.sh
│   ├── entrypoint.sh
│   ├── hello_django
│   │   ├── __init__.py
│   │   ├── settings.py
│   │   ├── urls.py
│   │   └── wsgi.py
│   └── manage.py
├── docker-compose.prod.yml
├── docker-compose.yml
└── nginx
    ├── Dockerfile
    └── nginx.conf
</pre></div>


<p>Bring the containers down once done:</p>
<div class="codehilite"><pre><span></span>$ docker-compose -f docker-compose.prod.yml down -v
</pre></div>


<p>Since Gunicorn is an application server, it will not serve up static files. So, how should both static and media files be handled in this particular configuration?</p>
<h2 id="static-files">Static Files</h2>
<p>Update <em>settings.py</em>:</p>
<div class="codehilite"><pre><span></span><span class="nv">STATIC_URL</span> <span class="o">=</span> <span class="s1">&#39;/staticfiles/&#39;</span>
<span class="nv">STATIC_ROOT</span> <span class="o">=</span> os.path.join<span class="o">(</span>BASE_DIR, <span class="s1">&#39;staticfiles&#39;</span><span class="o">)</span>
</pre></div>


<h3>Development</h3>
<p>Collect the static files in <em>entrypoint.sh</em>:</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$DATABASE</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;postgres&quot;</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for postgres...&quot;</span>

    <span class="k">while</span> ! nc -z <span class="nv">$SQL_HOST</span> <span class="nv">$SQL_PORT</span><span class="p">;</span> <span class="k">do</span>
      sleep <span class="m">0</span>.1
    <span class="k">done</span>

    <span class="nb">echo</span> <span class="s2">&quot;PostgreSQL started&quot;</span>
<span class="k">fi</span>

python manage.py flush --no-input
python manage.py migrate
python manage.py collectstatic --no-input --clear

<span class="nb">exec</span> <span class="s2">&quot;</span><span class="nv"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="527612">[email&#160;protected]</a></span><span class="s2">&quot;</span>
</pre></div>


<p>Now, any request to <code>http://localhost:8000/staticfiles/*</code> will be served from the "staticfiles" directory.</p>
<p>To test, first re-build the images and spin up the new containers per usual. When the <code>collectstatic</code> command is run, static files will be placed in the "staticfiles" directory. Ensure static files are still loading at <a href="http://localhost:8000/admin">http://localhost:8000/admin</a>. You can also verify in the logs -- via <code>docker-compose logs -f</code> -- that requests to the static files are served up successfully via Nginx:</p>
<div class="codehilite"><pre><span></span>web_1  <span class="p">|</span> <span class="o">[</span><span class="m">12</span>/Aug/2019 <span class="m">19</span>:07:36<span class="o">]</span> <span class="s2">&quot;GET /staticfiles/admin/css/login.css HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">1233</span>
web_1  <span class="p">|</span> <span class="o">[</span><span class="m">12</span>/Aug/2019 <span class="m">19</span>:07:36<span class="o">]</span> <span class="s2">&quot;GET /staticfiles/admin/css/base.css HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">16378</span>
web_1  <span class="p">|</span> <span class="o">[</span><span class="m">12</span>/Aug/2019 <span class="m">19</span>:07:36<span class="o">]</span> <span class="s2">&quot;GET /staticfiles/admin/css/responsive.css HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">17944</span>
web_1  <span class="p">|</span> <span class="o">[</span><span class="m">12</span>/Aug/2019 <span class="m">19</span>:07:36<span class="o">]</span> <span class="s2">&quot;GET /staticfiles/admin/css/fonts.css HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">423</span>
web_1  <span class="p">|</span> <span class="o">[</span><span class="m">12</span>/Aug/2019 <span class="m">19</span>:07:36<span class="o">]</span> <span class="s2">&quot;GET /staticfiles/admin/fonts/Roboto-Light-webfont.woff HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">85692</span>
web_1  <span class="p">|</span> <span class="o">[</span><span class="m">12</span>/Aug/2019 <span class="m">19</span>:07:36<span class="o">]</span> <span class="s2">&quot;GET /staticfiles/admin/fonts/Roboto-Regular-webfont.woff HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">85876</span>
</pre></div>


<h3>Production</h3>
<p>For production, add a volume to the <code>web</code> and <code>nginx</code> services to <em>docker-compose.prod.yml</em> so that each container will share a directory named "staticfiles":</p>
<div class="codehilite"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.7&#39;</span>

<span class="nt">services</span><span class="p">:</span>
  <span class="nt">web</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span>
      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./app</span>
      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span>
    <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">static_volume:/usr/src/app/staticfiles</span>
    <span class="nt">expose</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8000</span>
    <span class="nt">env_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.env</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">db</span>
  <span class="nt">db</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres:11.5-alpine</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span>
    <span class="nt">env_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.env.db</span>
  <span class="nt">nginx</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./nginx</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">static_volume:/usr/src/app/staticfiles</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1337:80</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web</span>

<span class="nt">volumes</span><span class="p">:</span>
  <span class="nt">postgres_data</span><span class="p">:</span>
  <span class="nt">static_volume</span><span class="p">:</span>
</pre></div>


<p>Update the Nginx configuration to route static file requests to the "staticfiles" folder:</p>
<div class="codehilite"><pre><span></span>upstream hello_django <span class="o">{</span>
    server web:8000<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>

    listen <span class="m">80</span><span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://hello_django<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
    <span class="o">}</span>

    location /staticfiles/ <span class="o">{</span>
        <span class="nb">alias</span> /usr/src/app/staticfiles/<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<p>Spin down the development containers:</p>
<div class="codehilite"><pre><span></span>$ docker-compose down -v
</pre></div>


<p>Test:</p>
<div class="codehilite"><pre><span></span>$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py migrate --noinput
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py collectstatic --no-input --clear
</pre></div>


<p>Again, requests to <code>http://localhost:1337/staticfiles/*</code> will be served from the "staticfiles" directory.</p>
<p>Navigate to <a href="http://localhost:1337/admin">http://localhost:1337/admin</a> and ensure the static assets load correctly.</p>
<p>Bring the containers:</p>
<div class="codehilite"><pre><span></span>$ docker-compose -f docker-compose.prod.yml down -v
</pre></div>


<h2 id="media-files">Media Files</h2>
<p>To test out the handling of media files, start by creating a new Django app:</p>
<div class="codehilite"><pre><span></span>$ docker-compose up -d --build
$ docker-compose <span class="nb">exec</span> web python manage.py startapp upload
</pre></div>


<p>Add the new app to the <code>INSTALLED_APPS</code> list in <em>settings.py</em>:</p>
<div class="codehilite"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>

    <span class="s1">&#39;upload&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>


<p><em>app/upload/views.py</em>:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.core.files.storage</span> <span class="kn">import</span> <span class="n">FileSystemStorage</span>


<span class="k">def</span> <span class="nf">image_upload</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;image_file&#39;</span><span class="p">]:</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;image_file&#39;</span><span class="p">]</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">FileSystemStorage</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)</span>
        <span class="n">image_url</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;upload.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;image_url&#39;</span><span class="p">:</span> <span class="n">image_url</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;upload.html&#39;</span><span class="p">)</span>
</pre></div>


<p>Add a "templates", directory to the "app/upload" directory, and then add a new template called <em>upload.html</em>:</p>
<div class="codehilite"><pre><span></span>{% block content %}

  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;{% url &quot;</span><span class="na">upload</span><span class="err">&quot;</span> <span class="err">%}&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span> <span class="na">enctype</span><span class="o">=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="p">&gt;</span>
    {% csrf_token %}
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;file&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;image_file&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>

  {% if image_url %}
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>File uploaded at: <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ image_url }}&quot;</span><span class="p">&gt;</span>{{ image_url }}<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  {% endif %}

{% endblock %}
</pre></div>


<p><em>app/hello_django/urls.py</em>:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.conf.urls.static</span> <span class="kn">import</span> <span class="n">static</span>

<span class="kn">from</span> <span class="nn">upload.views</span> <span class="kn">import</span> <span class="n">image_upload</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">image_upload</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;upload&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
    <span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">static</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_URL</span><span class="p">,</span> <span class="n">document_root</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">)</span>
</pre></div>


<p><em>app/hello_django/settings.py</em>:</p>
<div class="codehilite"><pre><span></span><span class="nv">MEDIA_URL</span> <span class="o">=</span> <span class="s1">&#39;/mediafiles/&#39;</span>
<span class="nv">MEDIA_ROOT</span> <span class="o">=</span> os.path.join<span class="o">(</span>BASE_DIR, <span class="s1">&#39;mediafiles&#39;</span><span class="o">)</span>
</pre></div>


<h3>Development</h3>
<p>Test:</p>
<div class="codehilite"><pre><span></span>$ docker-compose up -d --build
</pre></div>


<p>You should be able to upload an image at <a href="http://localhost:8000/">http://localhost:8000/</a>, and then view the image at <a href="http://localhost:8000/mediafiles/IMAGE_FILE_NAME">http://localhost:8000/mediafiles/IMAGE_FILE_NAME</a>.</p>
<h3>Production</h3>
<p>For production, add another volume to the <code>web</code> and <code>nginx</code> services:</p>
<div class="codehilite"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.7&#39;</span>

<span class="nt">services</span><span class="p">:</span>
  <span class="nt">web</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span>
      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./app</span>
      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile.prod</span>
    <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">static_volume:/usr/src/app/staticfiles</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">media_volume:/usr/src/app/mediafiles</span>
    <span class="nt">expose</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8000</span>
    <span class="nt">env_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.env</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">db</span>
  <span class="nt">db</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres:11.5-alpine</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">postgres_data:/var/lib/postgresql/data/</span>
    <span class="nt">env_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.env.db</span>
  <span class="nt">nginx</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./nginx</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">static_volume:/usr/src/app/staticfiles</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">media_volume:/usr/src/app/mediafiles</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1337:80</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web</span>

<span class="nt">volumes</span><span class="p">:</span>
  <span class="nt">postgres_data</span><span class="p">:</span>
  <span class="nt">static_volume</span><span class="p">:</span>
  <span class="nt">media_volume</span><span class="p">:</span>
</pre></div>


<p>Update the Nginx config again:</p>
<div class="codehilite"><pre><span></span>upstream hello_django <span class="o">{</span>
    server web:8000<span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>

    listen <span class="m">80</span><span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://hello_django<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
    <span class="o">}</span>

    location /staticfiles/ <span class="o">{</span>
        <span class="nb">alias</span> /usr/src/app/staticfiles/<span class="p">;</span>
    <span class="o">}</span>

    location /mediafiles/ <span class="o">{</span>
        <span class="nb">alias</span> /usr/src/app/mediafiles/<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<p>Re-build:</p>
<div class="codehilite"><pre><span></span>$ docker-compose down -v

$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py migrate --noinput
$ docker-compose -f docker-compose.prod.yml <span class="nb">exec</span> web python manage.py collectstatic --no-input --clear
</pre></div>


<p>Test it out one final time:</p>
<ol>
<li>Upload an image at <a href="http://localhost:1337/">http://localhost:1337/</a>.</li>
<li>Then, view the image at <a href="http://localhost:1337/mediafiles/IMAGE_FILE_NAME">http://localhost:1337/mediafiles/IMAGE_FILE_NAME</a>.</li>
</ol>
<h2 id="conclusion">Conclusion</h2>
<p>In this tutorial, we walked through how to containerize a Django web application with Postgres for development. We also created a production-ready Docker Compose file that adds Gunicorn and Nginx into the mix to handle static and media files. You can now test out a production setup locally. In terms of actual deployment to a production environment, you'll probably want to use a fully managed database service -- like <a href="https://aws.amazon.com/rds/">RDS</a> or <a href="https://cloud.google.com/sql/">Cloud SQL</a> -- rather than managing your own Postgres instance within a container. For other production tips, review <a href="https://www.reddit.com/r/django/comments/bjgod8/dockerizing_django_with_postgres_gunicorn_and/">this discussion</a>.</p>
<p>You can find the code in the <a href="https://github.com/testdrivenio/django-on-docker">django-on-docker</a> repo. Thanks for reading!</p></p>
    <br>
    <div class="addthis_inline_share_toolbox_u68o"></div>
  </main>
  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script
    type="text/javascript"
    src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50e5f1cc35ad077d"
  ></script>

        

  <br><hr><br>





      </div>
      <!-- Side -->
      
        


  
  
    <br>
<div class="blog-toc-container card box-shadow">
  <h4 class="card-header text-center">Table of Contents</h4>
  <div class="blog-toc-subcontainer">
    <ul class="blog-toc card-body" id="blog-toc" />
  </div>
</div>
<script>
  const headerList = document.getElementsByTagName('h2');
  let tocContainer = document.getElementById('blog-toc');
  for (el in headerList) {
    // blog-mobile-title
    if (headerList[el].innerHTML && headerList[el].innerHTML !== 'Contents') {
      if (headerList[el].className && headerList[el].className.includes('blog-mobile-title')) {
        // do nothing
      } else {
        // added to anchor target to push target below navbar
        headerList[el].setAttribute('style', 'padding-top: 60px; margin-top: -60px;');
        // create li
        let listElement = document.createElement('li');
        // create anchor
        let anchorElement = document.createElement('a');
        // set text and href values
        anchorElement.innerText = headerList[el].innerHTML;
        anchorElement.href = "#" + headerList[el].id;
        // append anchor to li, append li to ul
        listElement.appendChild(anchorElement);
        tocContainer.appendChild(listElement);
      }
    }
  }
</script>

  
</div>

        
      
    </div>
  </div>



    <!-- Footer -->
    
      <footer class="footer text-center">
  <div class="container">
    <hr>
    <small>
      <p>
        <span>&copy; Copyright 2017 - 2019 TestDriven Labs</span>.
        <br>
        <span>Developed by </span>
        <a href="http://mherman.org/">Michael Herman</a>.
      <p>
    </small>
    <div>
      <a
        href="https://twitter.com/testdrivenio?ref_src=twsrc%5Etfw"
        class="twitter-follow-button"
        data-show-count="false">
        Follow @testdrivenio
      </a>
      <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>
  </div>
</footer>

    
  </body>
</html>
